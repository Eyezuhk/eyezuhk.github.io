<!DOCTYPE html> <html lang="pt-br"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Script para habilitar auditorias Windows e Sysmon. | Eyezuhk Isaac Fernandes </title> <meta name="author" content="Eyezuhk Isaac Fernandes"> <meta name="description" content="Auditorias Windows e Sysmon"> <meta name="keywords" content="CyberSecurity, Malware-Analysis, DFIR, SIEM"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%99%A0%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://eyezuhk.github.io/pt-br/blog/2024/Audit-Sysmon/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/pt-br/"> <span class="font-weight-bold">Eyezuhk</span> Isaac Fernandes </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/pt-br/">Sobre </a> </li> <li class="nav-item active"> <a class="nav-link" href="/pt-br/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/pt-br/Differ/">Differ </a> </li> <li class="nav-item "> <a class="nav-link" href="/pt-br/HTMLive/">HTMLive </a> </li> <li class="nav-item "> <a class="nav-link" href="/pt-br/github-repositories/">Github Repositórios </a> </li> <li class="nav-item "> <a class="nav-link" href="/pt-br/cv/">CV </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/2024/Audit-Sysmon/"> EN-US</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Script para habilitar auditorias Windows e Sysmon.</h1> <p class="post-meta"> Criado em 11 de Novembro, 2024 </p> <p class="post-tags"> <a href="/pt-br/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/pt-br/blog/tag/windows-audit"> <i class="fa-solid fa-hashtag fa-sm"></i> Windows-Audit</a>   <a href="/pt-br/blog/tag/sysmon"> <i class="fa-solid fa-hashtag fa-sm"></i> Sysmon</a>   <a href="/pt-br/blog/tag/siem"> <i class="fa-solid fa-hashtag fa-sm"></i> SIEM</a>   ·   <a href="/pt-br/blog/category/scripts"> <i class="fa-solid fa-tag fa-sm"></i> Scripts</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Recentemente, precisei reconfigurar uma máquina para meu laboratório pessoal e, enquanto rodava o script que automatiza a configuração de algumas auditorias e configurações do Sysmon, lembrei que, principalmente para quem está começando na área, esse processo é muitas vezes feito manualmente. Embora isso seja ótimo para aprender, definitivamente pode ser automatizado.</p> <p>Então, decidi compartilhar um script PowerShell que automatiza a ativação das principais funcionalidades de auditoria.</p> <p>Se alguém tiver sugestões de auditorias adicionais que possam estar faltando ou melhorias para o arquivo de configuração do Sysmon, sua contribuição será muito bem-vinda!</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>Set-ExecutionPolicy <span class="nt">-Scope</span> Process <span class="nt">-ExecutionPolicy</span> Bypass <span class="nt">-Force</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
</pre></td> <td class="rouge-code"><pre><span class="c"># This PowerShell script enhances Windows security logging by enabling various event logs and installing Sysmon. </span>
<span class="c"># It prompts for admin rights and asks if you want to install Sysmon. If confirmed, it activates logs for user logon events, object access, privilege use, process tracking, and more. It also enables PowerShell script block logging and command line auditing for better visibility into executed commands.</span>

<span class="c">#powershell.exe -ExecutionPolicy Bypass -File .\Sysmon.ps1</span>

<span class="c"># Security Logs:</span>
<span class="c"># Logon/Logoff Events: Events related to user logon and logoff (Event IDs: 4624, 4625, 4634, 4647, etc.).</span>
<span class="c"># Object Access: Events related to accessing objects such as files, directories, and registry keys (Event IDs: 4656, 4663, etc.).</span>
<span class="c"># Privilege Use: Events related to the use of sensitive privileges (Event IDs: 4672, 4673, etc.).</span>
<span class="c"># Process Tracking: Events related to the creation, termination, and access of processes (Event IDs: 4688, 4689, etc.).</span>
<span class="c"># Account Logon: Events related to account logon and logoff (Event IDs: 4624, 4625, 4634, 4647, etc.).</span>
<span class="c"># Account Management: Events related to the creation, modification, and deletion of user accounts (Event IDs: 4720, 4722, 4724, etc.).</span>
<span class="c"># Policy Changes: Events related to changes in security policies (Event IDs: 4670, 4719, etc.).</span>
<span class="c"># System Events: Events related to system changes, such as updates, drivers, etc. (Event IDs: 4610, 4615, etc.).</span>
<span class="c"># Group Membership: Events related to adding and removing users from groups (Event IDs: 4728, 4732, 4756, etc.).</span>
<span class="c"># Sensitive Privilege Use: Events related to the use of sensitive privileges, such as the ability to debug processes (Event IDs: 4672, 4673, etc.).</span>

<span class="c"># PowerShell Script Log: The script activates PowerShell script block logging, allowing auditing of scripts executed on the system.</span>
<span class="c"># Command Line Log: The script activates auditing of Event 4688, which records the full command line used to create new processes.</span>

<span class="c"># Additional Security Logs:</span>
<span class="c"># Remote Desktop Services: Events related to the use of Remote Desktop Services (RDP).</span>
<span class="c"># Local Session Manager of Terminal Services: Events related to local terminal sessions.</span>
<span class="c"># Remote Connection Manager of Terminal Services: Events related to remote terminal connections.</span>
<span class="c"># SMB Client: Events related to the use of the SMB (Server Message Block) client for file sharing.</span>
<span class="c"># SMB Server: Events related to the SMB (Server Message Block) server for file sharing.</span>
<span class="c"># Application Log: The script activates the application log, which records events related to applications and services running on the system.</span>
<span class="c"># System Log: The script activates the system log, which records events related to the Windows kernel and drivers.</span>


<span class="c"># Check if the user has elevated permissions (Administrator)</span>
<span class="k">if</span> <span class="o">(</span><span class="nt">-not</span> <span class="o">([</span>Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent<span class="o">())</span>.IsInRole<span class="o">([</span>Security.Principal.WindowsBuiltInRole] <span class="s2">"Administrator"</span><span class="o">))</span> <span class="o">{</span>
    Write-Warning <span class="s2">"This script requires administrative privileges. Please run it as an administrator."</span>
    Exit
<span class="o">}</span>

<span class="c"># Prompt user to install Sysmon</span>
<span class="nv">$InstallSysmon</span> <span class="o">=</span> Read-Host <span class="s2">"Do you want to install Sysmon? (Y/N)"</span>
<span class="nv">$InstallSysmon</span> <span class="o">=</span> <span class="nv">$InstallSysmon</span>.ToLower<span class="o">()</span>

<span class="c"># Enable Security Event Log</span>
<span class="nv">$SecurityLogPath</span> <span class="o">=</span> <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\P</span><span class="s2">olicies</span><span class="se">\S</span><span class="s2">ystem</span><span class="se">\A</span><span class="s2">udit"</span>
<span class="k">if</span> <span class="o">(</span><span class="nt">-not</span> <span class="o">(</span>Test-Path <span class="nv">$SecurityLogPath</span><span class="o">))</span> <span class="o">{</span>
    Write-Output <span class="s2">"Creating registry key: </span><span class="nv">$SecurityLogPath</span><span class="s2">"</span>
    New-Item <span class="nt">-Path</span> <span class="nv">$SecurityLogPath</span> <span class="nt">-Force</span> | Out-Null
<span class="o">}</span>

Write-Output <span class="s2">"Enabling Security Event Log settings"</span>
<span class="nv">$SecuritySettings</span> <span class="o">=</span> @<span class="o">{</span>
    AuditLogonEvents <span class="o">=</span> 3
    AuditObjectAccess <span class="o">=</span> 3
    AuditPrivilegeUse <span class="o">=</span> 3
    AuditProcessTracking <span class="o">=</span> 3
    AuditAccountLogon <span class="o">=</span> 3
    AuditAccountManagement <span class="o">=</span> 3
    AuditPolicyChange <span class="o">=</span> 3
    AuditSystemEvents <span class="o">=</span> 3
    AuditGroupMembership <span class="o">=</span> 3
    AuditSensitivePrivilegeUse <span class="o">=</span> 3
<span class="o">}</span>
<span class="nv">$SecuritySettings</span>.GetEnumerator<span class="o">()</span> | ForEach-Object <span class="o">{</span>
    Set-ItemProperty <span class="nt">-Path</span> <span class="nv">$SecurityLogPath</span> <span class="nt">-Name</span> <span class="nv">$_</span>.Key <span class="nt">-Value</span> <span class="nv">$_</span>.Value <span class="nt">-Force</span>
<span class="o">}</span>

<span class="c"># Enable PowerShell Logging with Script Block</span>
<span class="nv">$RegistryPath</span> <span class="o">=</span> <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\P</span><span class="s2">olicies</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\P</span><span class="s2">owerShell</span><span class="se">\S</span><span class="s2">criptBlockLogging"</span>
<span class="k">if</span> <span class="o">(</span><span class="nt">-not</span> <span class="o">(</span>Test-Path <span class="nv">$RegistryPath</span><span class="o">))</span> <span class="o">{</span>
    Write-Output <span class="s2">"Creating registry key: </span><span class="nv">$RegistryPath</span><span class="s2">"</span>
    New-Item <span class="nt">-Path</span> <span class="nv">$RegistryPath</span> <span class="nt">-Force</span> | Out-Null
<span class="o">}</span>
Write-Output <span class="s2">"Enabling PowerShell Script Block Logging"</span>
Set-ItemProperty <span class="nt">-Path</span> <span class="nv">$RegistryPath</span> <span class="nt">-Name</span> <span class="s2">"EnableScriptBlockLogging"</span> <span class="nt">-Value</span> 1 <span class="nt">-Type</span> DWord <span class="nt">-Force</span>

<span class="c"># Enable Command Line Audit Event 4688</span>
<span class="nv">$RegistryPath</span> <span class="o">=</span> <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\P</span><span class="s2">olicies</span><span class="se">\S</span><span class="s2">ystem</span><span class="se">\A</span><span class="s2">udit"</span>
<span class="k">if</span> <span class="o">(</span><span class="nt">-not</span> <span class="o">(</span>Test-Path <span class="nv">$RegistryPath</span><span class="o">))</span> <span class="o">{</span>
    Write-Output <span class="s2">"Creating registry key: </span><span class="nv">$RegistryPath</span><span class="s2">"</span>
    New-Item <span class="nt">-Path</span> <span class="nv">$RegistryPath</span> <span class="nt">-Force</span> | Out-Null
<span class="o">}</span>
Write-Output <span class="s2">"Enabling Command Line Audit Event 4688"</span>
Set-ItemProperty <span class="nt">-Path</span> <span class="nv">$RegistryPath</span> <span class="nt">-Name</span> <span class="s2">"AuditProcessCreation"</span> <span class="nt">-Value</span> 3 <span class="nt">-Type</span> DWord <span class="nt">-Force</span>
Set-ItemProperty <span class="nt">-Path</span> <span class="nv">$RegistryPath</span> <span class="nt">-Name</span> <span class="s2">"ProcessCreationIncludeCmdLine_Enabled"</span> <span class="nt">-Value</span> 1 <span class="nt">-Type</span> DWord <span class="nt">-Force</span>

<span class="c"># Enable Additional Security Logs</span>
<span class="nv">$SecurityLogPaths</span> <span class="o">=</span> @<span class="o">(</span>
    <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\W</span><span class="s2">inevt</span><span class="se">\C</span><span class="s2">hannels</span><span class="se">\M</span><span class="s2">icrosoft-Windows-RemoteDesktopServices-RdpCoreTS/Operational"</span>,
    <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\W</span><span class="s2">inevt</span><span class="se">\C</span><span class="s2">hannels</span><span class="se">\M</span><span class="s2">icrosoft-Windows-TerminalServices-LocalSessionManager/Operational"</span>,
    <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\W</span><span class="s2">inevt</span><span class="se">\C</span><span class="s2">hannels</span><span class="se">\M</span><span class="s2">icrosoft-Windows-TerminalServices-RemoteConnectionManager/Operational"</span>,
    <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\W</span><span class="s2">inevt</span><span class="se">\C</span><span class="s2">hannels</span><span class="se">\M</span><span class="s2">icrosoft-Windows-SmbClient/Security"</span>,
    <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\W</span><span class="s2">inevt</span><span class="se">\C</span><span class="s2">hannels</span><span class="se">\M</span><span class="s2">icrosoft-Windows-SMBServer/Security"</span>
<span class="o">)</span>

foreach <span class="o">(</span><span class="nv">$LogPath</span> <span class="k">in</span> <span class="nv">$SecurityLogPaths</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nt">-not</span> <span class="o">(</span>Test-Path <span class="nv">$LogPath</span><span class="o">))</span> <span class="o">{</span>
        Write-Output <span class="s2">"Creating registry key: </span><span class="nv">$LogPath</span><span class="s2">"</span>
        New-Item <span class="nt">-Path</span> <span class="nv">$LogPath</span> <span class="nt">-Force</span> | Out-Null
    <span class="o">}</span>
    Write-Output <span class="s2">"Enabling </span><span class="si">$(</span><span class="nv">$LogPath</span>.Split<span class="o">(</span><span class="s1">'\\'</span><span class="o">)[</span><span class="nt">-1</span><span class="o">]</span><span class="si">)</span><span class="s2"> log"</span>
    New-ItemProperty <span class="nt">-Path</span> <span class="nv">$LogPath</span> <span class="nt">-Name</span> <span class="s2">"Enabled"</span> <span class="nt">-Value</span> 1 <span class="nt">-PropertyType</span> DWord <span class="nt">-Force</span>
<span class="o">}</span>

<span class="c"># Enable Application Event Log</span>
<span class="nv">$ApplicationLogPath</span> <span class="o">=</span> <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\W</span><span class="s2">inevt</span><span class="se">\C</span><span class="s2">hannels</span><span class="se">\M</span><span class="s2">icrosoft-Windows-Application-Experience/Analytic"</span>
<span class="k">if</span> <span class="o">(</span><span class="nt">-not</span> <span class="o">(</span>Test-Path <span class="nv">$ApplicationLogPath</span><span class="o">))</span> <span class="o">{</span>
    Write-Output <span class="s2">"Creating registry key: </span><span class="nv">$ApplicationLogPath</span><span class="s2">"</span>
    New-Item <span class="nt">-Path</span> <span class="nv">$ApplicationLogPath</span> <span class="nt">-Force</span> | Out-Null
<span class="o">}</span>
Write-Output <span class="s2">"Enabling Application Event Log"</span>
New-ItemProperty <span class="nt">-Path</span> <span class="nv">$ApplicationLogPath</span> <span class="nt">-Name</span> <span class="s2">"Enabled"</span> <span class="nt">-Value</span> 1 <span class="nt">-PropertyType</span> DWord <span class="nt">-Force</span>

<span class="c"># Enable System Event Log</span>
<span class="nv">$SystemLogPath</span> <span class="o">=</span> <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\W</span><span class="s2">inevt</span><span class="se">\C</span><span class="s2">hannels</span><span class="se">\M</span><span class="s2">icrosoft-Windows-Kernel-General/Analytic"</span>
<span class="k">if</span> <span class="o">(</span><span class="nt">-not</span> <span class="o">(</span>Test-Path <span class="nv">$SystemLogPath</span><span class="o">))</span> <span class="o">{</span>
    Write-Output <span class="s2">"Creating registry key: </span><span class="nv">$SystemLogPath</span><span class="s2">"</span>
    New-Item <span class="nt">-Path</span> <span class="nv">$SystemLogPath</span> <span class="nt">-Force</span> | Out-Null
<span class="o">}</span>
Write-Output <span class="s2">"Enabling System Event Log"</span>
New-ItemProperty <span class="nt">-Path</span> <span class="nv">$SystemLogPath</span> <span class="nt">-Name</span> <span class="s2">"Enabled"</span> <span class="nt">-Value</span> 1 <span class="nt">-PropertyType</span> DWord <span class="nt">-Force</span>

<span class="c"># Check if Sysmon is installed</span>
<span class="nv">$SysmonInstalled</span> <span class="o">=</span> Test-Path <span class="s2">"C:</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\S</span><span class="s2">ysmonDrv.sys"</span>

<span class="c"># Uninstall Sysmon if it's already installed</span>
<span class="k">if</span> <span class="o">(</span><span class="nv">$InstallSysmon</span> <span class="nt">-eq</span> <span class="s2">"y"</span><span class="o">)</span> <span class="o">{</span>
    <span class="nv">$SysmonPath</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:TEMP</span><span class="se">\S</span><span class="s2">ysmon.zip"</span>
    <span class="nv">$SysmonUrl</span> <span class="o">=</span> <span class="s2">"https://download.sysinternals.com/files/Sysmon.zip"</span>
    <span class="nv">$SysmonConfigUrl</span> <span class="o">=</span> <span class="s2">"https://raw.githubusercontent.com/Eyezuhk/InfoSec-Misc/refs/heads/main/Sysmon/sysmonconfig-export.xml"</span>
    <span class="nv">$SysmonConfigPath</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:ProgramData</span><span class="se">\S</span><span class="s2">ysmon</span><span class="se">\c</span><span class="s2">onfig.xml"</span>

    <span class="c"># Verify and create the Sysmon directory if it doesn't exist</span>
    <span class="nv">$SysmonDir</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:ProgramData</span><span class="se">\S</span><span class="s2">ysmon"</span>
    <span class="k">if</span> <span class="o">(</span><span class="nt">-not</span> <span class="o">(</span>Test-Path <span class="nv">$SysmonDir</span><span class="o">))</span> <span class="o">{</span>
        Write-Output <span class="s2">"Creating Sysmon directory: </span><span class="nv">$SysmonDir</span><span class="s2">"</span>
        New-Item <span class="nt">-ItemType</span> Directory <span class="nt">-Path</span> <span class="nv">$SysmonDir</span> | Out-Null
    <span class="o">}</span>

    <span class="c"># Download files using .NET WebClient</span>
    <span class="nv">$WebClient</span> <span class="o">=</span> New-Object System.Net.WebClient
    
    <span class="c"># Set TLS 1.2 as the default protocol for WebClient</span>
    <span class="o">[</span>System.Net.ServicePointManager]::SecurityProtocol <span class="o">=</span> <span class="o">[</span>System.Net.SecurityProtocolType]::Tls12
    
    Write-Output <span class="s2">"Downloading Sysmon archive..."</span>
    <span class="nv">$WebClient</span>.DownloadFile<span class="o">(</span><span class="nv">$SysmonUrl</span>, <span class="nv">$SysmonPath</span><span class="o">)</span>
    Write-Output <span class="s2">"Downloading Sysmon configuration..."</span>
    <span class="nv">$WebClient</span>.DownloadFile<span class="o">(</span><span class="nv">$SysmonConfigUrl</span>, <span class="nv">$SysmonConfigPath</span><span class="o">)</span>

    Write-Output <span class="s2">"Expanding Sysmon archive to </span><span class="nv">$env</span><span class="s2">:TEMP</span><span class="se">\S</span><span class="s2">ysmon"</span>
    Expand-Archive <span class="nt">-Path</span> <span class="nv">$SysmonPath</span> <span class="nt">-DestinationPath</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:TEMP</span><span class="se">\S</span><span class="s2">ysmon"</span> <span class="nt">-Force</span>

    Write-Output <span class="s2">"Installing and enabling Sysmon with configuration: </span><span class="nv">$SysmonConfigPath</span><span class="s2">"</span>
    &amp; <span class="s2">"</span><span class="nv">$env</span><span class="s2">:TEMP</span><span class="se">\S</span><span class="s2">ysmon</span><span class="se">\S</span><span class="s2">ysmon64.exe"</span> <span class="nt">-accepteula</span> <span class="nt">-i</span> <span class="nv">$SysmonConfigPath</span>

    Remove-Item <span class="nt">-Recurse</span> <span class="nt">-Force</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:TEMP</span><span class="se">\S</span><span class="s2">ysmon"</span> <span class="nt">-Confirm</span>:<span class="nv">$false</span>
<span class="o">}</span>

Prompt user to press a key before exiting
Write-Host <span class="s2">"Press any key to exit..."</span>
<span class="nv">$null</span> <span class="o">=</span> <span class="nv">$Host</span>.UI.RawUI.ReadKey<span class="o">(</span><span class="s2">"NoEcho,IncludeKeyDown"</span><span class="o">)</span>
</pre></td> </tr></tbody></table></code></pre></div></div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Gostou de Ler este Artigo?</h2> <p class="mb-2">Aqui estão alguns artigos relacionados que você pode gostar de ler:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/pt-br/blog/2024/Audit-Sysmon/">Script for enabling Windows Audit and Sysmon.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/pt-br/blog/2022/CyberDefenders-Qradar101-Write-up/">CyberDefenders Qradar101 Write up.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/pt-br/blog/2024/Guacamole/">Step-by-step Apache Guacamole Installation.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/pt-br/blog/2024/FnStegoCrypt/">FnStegoCrypt - Encrypted Data in Images</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/pt-br/blog/2024/CVE-2024-35250/">Detection CVE-2024-35250</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/pt-br/blog/2024/FNLocalCloud/">Exposing Local Applications with FNLocalCloud.</a> </li> <div id="giscus_thread" style="max-width: 1000px; margin: 0 auto;"> <script>let giscusTheme=determineComputedTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"Eyezuhk/eyezuhk.github.io","data-repo-id":"R_kgDONTi2VA","data-category":"General","data-category-id":"DIC_kwDONTi2VM4Ck09L","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2024 Eyezuhk Isaac Fernandes. Disclaimer. All the opinions and views discussed here are mine and do not necessarily represent the views of my employer. I am not an expert. I am just sharing my views on topics, and I’m open to other perspectives. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Digite para iniciar a busca"> <div class="modal-footer" slot="footer"> <span class="help"> <svg version="1.0" class="ninja-examplekey" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1280 1280"> <path d="M1013 376c0 73.4-.4 113.3-1.1 120.2a159.9 159.9 0 0 1-90.2 127.3c-20 9.6-36.7 14-59.2 15.5-7.1.5-121.9.9-255 1h-242l95.5-95.5 95.5-95.5-38.3-38.2-38.2-38.3-160 160c-88 88-160 160.4-160 161 0 .6 72 73 160 161l160 160 38.2-38.3 38.3-38.2-95.5-95.5-95.5-95.5h251.1c252.9 0 259.8-.1 281.4-3.6 72.1-11.8 136.9-54.1 178.5-116.4 8.6-12.9 22.6-40.5 28-55.4 4.4-12 10.7-36.1 13.1-50.6 1.6-9.6 1.8-21 2.1-132.8l.4-122.2H1013v110z"></path> </svg> para selecionar </span> <span class="help"> <svg xmlns="http://www.w3.org/2000/svg" class="ninja-examplekey" viewbox="0 0 24 24"> <path d="M0 0h24v24H0V0z" fill="none"></path> <path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"></path> </svg> <svg xmlns="http://www.w3.org/2000/svg" class="ninja-examplekey" viewbox="0 0 24 24"> <path d="M0 0h24v24H0V0z" fill="none"></path> <path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"></path> </svg> para navegar </span> <span class="help"> <span class="ninja-examplekey esc">esc</span> para fechar </span> <span class="help"> <svg xmlns="http://www.w3.org/2000/svg" class="ninja-examplekey backspace" viewbox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M6.707 4.879A3 3 0 018.828 4H15a3 3 0 013 3v6a3 3 0 01-3 3H8.828a3 3 0 01-2.12-.879l-4.415-4.414a1 1 0 010-1.414l4.414-4.414zm4 2.414a1 1 0 00-1.414 1.414L10.586 10l-1.293 1.293a1 1 0 101.414 1.414L12 11.414l1.293 1.293a1 1 0 001.414-1.414L13.414 10l1.293-1.293a1 1 0 00-1.414-1.414L12 8.586l-1.293-1.293z" clip-rule="evenodd"></path> </svg> voltar um nível </span> </div> </ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-sobre",title:"Sobre",section:"Menu de navega\xe7\xe3o",handler:()=>{window.location.href="/pt-br/"}},{id:"nav-blog",title:"Blog",description:"Uma cole\xe7\xe3o dos meus pensamentos sobre ciberseguran\xe7a e opini\xf5es pessoais que abrangem diversos t\xf3picos.",section:"Menu de navega\xe7\xe3o",handler:()=>{window.location.href="/pt-br/blog/"}},{id:"nav-differ",title:"Differ",description:"",section:"Menu de navega\xe7\xe3o",handler:()=>{window.location.href="/pt-br/Differ/"}},{id:"nav-htmlive",title:"HTMLive",description:"",section:"Menu de navega\xe7\xe3o",handler:()=>{window.location.href="/pt-br/HTMLive/"}},{id:"nav-github-reposit\xf3rios",title:"Github Reposit\xf3rios",description:"Projetos pessoais.",section:"Menu de navega\xe7\xe3o",handler:()=>{window.location.href="/pt-br/github-repositories/"}},{id:"nav-cv",title:"CV",description:"Curriculum Vitae.",section:"Menu de navega\xe7\xe3o",handler:()=>{window.location.href="/pt-br/cv/"}},{id:"post-detection-cve-2024-35250",title:"Detection CVE-2024-35250",description:"Detecta quando cmd.exe com privil\xe9gios de sistema \xe9 executado depois que um processo carrega &#39;ksproxy.ax&#39; e &#39;ksuser.dll&#39;, indicando poss\xedvel explora\xe7\xe3o do CVE-2024-35250.",section:"Postagens",handler:()=>{window.location.href="/pt-br/blog/2024/CVE-2024-35250/"}},{id:"post-apts-ou-uaps",title:"APTs ou UAPs?",description:"Como Fen\xf4menos An\xf4malos se Assemelham a Amea\xe7as Cibern\xe9ticas.",section:"Postagens",handler:()=>{window.location.href="/pt-br/blog/2024/APT-UAP/"}},{id:"post-passo-a-passo-instala\xe7\xe3o-apache-guacamole",title:"Passo a passo instala\xe7\xe3o Apache Guacamole.",description:"Instala\xe7\xe3o Guacamole",section:"Postagens",handler:()=>{window.location.href="/pt-br/blog/2024/Guacamole/"}},{id:"post-script-para-habilitar-auditorias-windows-e-sysmon",title:"Script para habilitar auditorias Windows e Sysmon.",description:"Auditorias Windows e Sysmon",section:"Postagens",handler:()=>{window.location.href="/pt-br/blog/2024/Audit-Sysmon/"}},{id:"post-fnstegocrypt-dados-encriptados-em-imagens",title:"FnStegoCrypt dados encriptados em imagens.",description:"Programa que encripta os dados com aes-gcm e adiciona a imagens usando LSB.",section:"Postagens",handler:()=>{window.location.href="/pt-br/blog/2024/FnStegoCrypt/"}},{id:"post-expondo-aplica\xe7\xf5es-locais-com-fnlocalcloud",title:"Expondo aplica\xe7\xf5es locais com FNLocalCloud.",description:"Programa baseado em agente e servidor para expor servi\xe7os de rede locais na internet bypassando cgnat...",section:"Postagens",handler:()=>{window.location.href="/pt-br/blog/2024/FNLocalCloud/"}},{id:"post-first-fortaleza-2023",title:"FIRST Fortaleza 2023.",description:"FIRST (Forum of Incident Response and Security Teams)",section:"Postagens",handler:()=>{window.location.href="/pt-br/blog/2023/First/"}},{id:"post-resolu\xe7\xe3o-cyberdefenders-qradar101",title:"Resolu\xe7\xe3o CyberDefenders Qradar101.",description:"Resolu\xe7\xe3o de CTF",section:"Postagens",handler:()=>{window.location.href="/pt-br/blog/2022/CyberDefenders-Qradar101-Write-up/"}},{id:"news-memento-mori",title:"Memento mori.",description:"",section:"Novidades"},{id:"projects-projects",title:"Projects",description:"with background image",section:"Projetos",handler:()=>{window.location.href="/pt-br/projects/1_project/"}},{id:"socials-email",title:"Enviar um email",section:"Redes sociais",handler:()=>{window.open("mailto:%65%79%65%7A%75%68%6B@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-github",title:"GitHub",section:"Redes sociais",handler:()=>{window.open("https://github.com/Eyezuhk","_blank")}},{id:"socials-linkedin",title:"LinkedIn",section:"Redes sociais",handler:()=>{window.open("https://www.linkedin.com/in/isaacfn","_blank")}},{id:"socials-spotify",title:"Spotify",section:"Redes sociais",handler:()=>{window.open("https://open.spotify.com/user/12144303025","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Redes sociais",handler:()=>{window.open("/feed.xml","_blank")}},{id:"lang-en-us",title:"en-us",section:"Idiomas",handler:()=>{window.location.href="/blog/2024/Audit-Sysmon/"}},{id:"light-theme",title:"Muda o tema para claro",description:"Muda o tema do site para claro",section:"Tema",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Muda o tema para escuro",description:"Muda o tema do site para escuro",section:"Tema",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Usa o tema padr\xe3o do sistema",description:"Muda o tema do site para o padr\xe3o do sistema",section:"Tema",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>