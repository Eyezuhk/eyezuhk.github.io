<!DOCTYPE html> <html lang="en-us"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Script for enabling Windows Audit and Sysmon. | Eyezuhk Isaac Fernandes </title> <meta name="author" content="Eyezuhk Isaac Fernandes"> <meta name="description" content="Windows audit and Sysmon"> <meta name="keywords" content="CyberSecurity, Malware-Analysis, DFIR, SIEM"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%99%A0%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://eyezuhk.github.io/blog/2024/Audit-Sysmon/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Eyezuhk</span> Isaac Fernandes </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/Differ/">Differ </a> </li> <li class="nav-item "> <a class="nav-link" href="/HTMLive/">HTMLive </a> </li> <li class="nav-item "> <a class="nav-link" href="/Pomodoro/">Pomodoro </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="nav-item "> <a class="nav-link" href="/github-repositories/">Github Repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="nav-item active"> <a class="nav-link" href="/pt-br/blog/2024/Audit-Sysmon/"> PT-BR</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Script for enabling Windows Audit and Sysmon.</h1> <p class="post-meta"> Created in November 11, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/windows-audit"> <i class="fa-solid fa-hashtag fa-sm"></i> Windows-Audit</a>   <a href="/blog/tag/sysmon"> <i class="fa-solid fa-hashtag fa-sm"></i> Sysmon</a>   <a href="/blog/tag/siem"> <i class="fa-solid fa-hashtag fa-sm"></i> SIEM</a>   ·   <a href="/blog/category/scripts"> <i class="fa-solid fa-tag fa-sm"></i> Scripts</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Recently, I needed to reconfigure a machine for my personal lab, and while running the script that automates the setup of some Sysmon audits and configurations, I remembered that, especially for those starting in the field, this process is often done manually. While this is great for learning, it can definitely be automated.</p> <p>So, I decided to share a PowerShell script that automates the activation of the main auditing features.</p> <p>If anyone has suggestions for additional audits that might be missing or improvements for the Sysmon configuration file, your contributions would be greatly appreciated!</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre>Set-ExecutionPolicy <span class="nt">-Scope</span> Process <span class="nt">-ExecutionPolicy</span> Bypass <span class="nt">-Force</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
</pre></td> <td class="rouge-code"><pre><span class="c">#Requires -RunAsAdministrator</span>

<span class="c">#powershell.exe -ExecutionPolicy Bypass -File .\Sysmon.ps1</span>

<span class="k">function </span>Enable-AuditPolicies <span class="o">{</span>
    Write-Output <span class="s2">"Configuring advanced audit policies for threat hunting..."</span>
    
    <span class="c"># Enable Process Creation with Command Line</span>
    auditpol /set /subcategory:<span class="s2">"Process Creation"</span> /success:enable /failure:enable
    reg add <span class="s2">"HKLM</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\P</span><span class="s2">olicies</span><span class="se">\S</span><span class="s2">ystem</span><span class="se">\A</span><span class="s2">udit"</span> /v <span class="s2">"ProcessCreationIncludeCmdLine_Enabled"</span> /t REG_DWORD /d 1 /f
    
    <span class="c"># Enhanced Security Audit Policy Configuration</span>
    <span class="nv">$auditPolicies</span> <span class="o">=</span> @<span class="o">{</span>
        <span class="c"># Critical for detecting credential theft and authentication attacks</span>
        <span class="s2">"Account Logon"</span> <span class="o">=</span> @<span class="o">(</span>
            <span class="s2">"Credential Validation"</span>,
            <span class="s2">"Kerberos Authentication Service"</span>,
            <span class="s2">"Kerberos Service Ticket Operations"</span>
        <span class="o">)</span>
        <span class="c"># Track account management and modifications</span>
        <span class="s2">"Account Management"</span> <span class="o">=</span> @<span class="o">(</span>
            <span class="s2">"User Account Management"</span>,
            <span class="s2">"Security Group Management"</span>,
            <span class="s2">"Computer Account Management"</span>
        <span class="o">)</span>
        <span class="c"># Essential for process tracking and command execution</span>
        <span class="s2">"Detailed Tracking"</span> <span class="o">=</span> @<span class="o">(</span>
            <span class="s2">"Process Creation"</span>,
            <span class="s2">"Process Termination"</span>,
            <span class="s2">"DPAPI Activity"</span>,
            <span class="s2">"RPC Events"</span>
        <span class="o">)</span>
        <span class="c"># Critical for lateral movement detection</span>
        <span class="s2">"Logon/Logoff"</span> <span class="o">=</span> @<span class="o">(</span>
            <span class="s2">"Logon"</span>,
            <span class="s2">"Logoff"</span>,
            <span class="s2">"Special Logon"</span>,
            <span class="s2">"Other Logon/Logoff Events"</span>,
            <span class="s2">"Network Policy Server"</span>
        <span class="o">)</span>
        <span class="c"># File and registry access monitoring</span>
        <span class="s2">"Object Access"</span> <span class="o">=</span> @<span class="o">(</span>
            <span class="s2">"File System"</span>,
            <span class="s2">"Registry"</span>,
            <span class="s2">"Kernel Object"</span>,
            <span class="s2">"SAM"</span>,
            <span class="s2">"Certification Services"</span>,
            <span class="s2">"Handle Manipulation"</span>
        <span class="o">)</span>
        <span class="c"># Track security policy changes</span>
        <span class="s2">"Policy Change"</span> <span class="o">=</span> @<span class="o">(</span>
            <span class="s2">"Audit Policy Change"</span>,
            <span class="s2">"Authentication Policy Change"</span>,
            <span class="s2">"Authorization Policy Change"</span>
        <span class="o">)</span>
        <span class="c"># Monitor privileged operations</span>
        <span class="s2">"Privilege Use"</span> <span class="o">=</span> @<span class="o">(</span>
            <span class="s2">"Sensitive Privilege Use"</span>,
            <span class="s2">"Non Sensitive Privilege Use"</span>
        <span class="o">)</span>
        <span class="c"># System level changes and security state</span>
        <span class="s2">"System"</span> <span class="o">=</span> @<span class="o">(</span>
            <span class="s2">"Security State Change"</span>,
            <span class="s2">"Security System Extension"</span>,
            <span class="s2">"System Integrity"</span>
        <span class="o">)</span>
    <span class="o">}</span>

    foreach <span class="o">(</span><span class="nv">$category</span> <span class="k">in</span> <span class="nv">$auditPolicies</span>.Keys<span class="o">)</span> <span class="o">{</span>
        foreach <span class="o">(</span><span class="nv">$subcategory</span> <span class="k">in</span> <span class="nv">$auditPolicies</span><span class="o">[</span><span class="nv">$category</span><span class="o">])</span> <span class="o">{</span>
            Write-Output <span class="s2">"Enabling audit policy: </span><span class="nv">$category</span><span class="s2"> - </span><span class="nv">$subcategory</span><span class="s2">"</span>
            auditpol /set /subcategory:<span class="s2">"</span><span class="nv">$subcategory</span><span class="s2">"</span> /success:enable /failure:enable
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c"># Enhanced PowerShell Logging</span>
    <span class="nv">$registryPaths</span> <span class="o">=</span> @<span class="o">{</span>
        <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\P</span><span class="s2">olicies</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\P</span><span class="s2">owerShell</span><span class="se">\S</span><span class="s2">criptBlockLogging"</span> <span class="o">=</span> @<span class="o">{</span>
            <span class="s2">"EnableScriptBlockLogging"</span> <span class="o">=</span> 1
            <span class="s2">"EnableScriptBlockInvocationLogging"</span> <span class="o">=</span> 1
        <span class="o">}</span>
        <span class="s2">"HKLM:</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\P</span><span class="s2">olicies</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\P</span><span class="s2">owerShell</span><span class="se">\M</span><span class="s2">oduleLogging"</span> <span class="o">=</span> @<span class="o">{</span>
            <span class="s2">"EnableModuleLogging"</span> <span class="o">=</span> 1
        <span class="o">}</span>

    <span class="o">}</span>

    foreach <span class="o">(</span><span class="nv">$path</span> <span class="k">in</span> <span class="nv">$registryPaths</span>.Keys<span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nt">-not</span> <span class="o">(</span>Test-Path <span class="nv">$path</span><span class="o">))</span> <span class="o">{</span>
            New-Item <span class="nt">-Path</span> <span class="nv">$path</span> <span class="nt">-Force</span> | Out-Null
        <span class="o">}</span>
        foreach <span class="o">(</span><span class="nv">$name</span> <span class="k">in</span> <span class="nv">$registryPaths</span><span class="o">[</span><span class="nv">$path</span><span class="o">]</span>.Keys<span class="o">)</span> <span class="o">{</span>
            Set-ItemProperty <span class="nt">-Path</span> <span class="nv">$path</span> <span class="nt">-Name</span> <span class="nv">$name</span> <span class="nt">-Value</span> <span class="nv">$registryPaths</span><span class="o">[</span><span class="nv">$path</span><span class="o">][</span><span class="nv">$name</span><span class="o">]</span> <span class="nt">-Type</span> DWord <span class="nt">-Force</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c"># Enable Windows Security Event Log Size</span>
    Write-Output <span class="s2">"Configuring Security Event Log size 2GB ..."</span>
    wevtutil sl Security /ms:2147483648 <span class="c"># 2GB</span>
<span class="o">}</span>

<span class="k">function </span>Install-Sysmon <span class="o">{</span>
    param <span class="o">(</span>
        <span class="o">[</span>string]<span class="nv">$ConfigUrl</span> <span class="o">=</span> <span class="s2">"https://raw.githubusercontent.com/SwiftOnSecurity/sysmon-config/master/sysmonconfig-export.xml"</span>
    <span class="o">)</span>

    <span class="nv">$sysmonPath</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:TEMP</span><span class="se">\S</span><span class="s2">ysmon.zip"</span>
    <span class="nv">$sysmonUrl</span> <span class="o">=</span> <span class="s2">"https://download.sysinternals.com/files/Sysmon.zip"</span>
    <span class="nv">$sysmonConfigPath</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:ProgramData</span><span class="se">\S</span><span class="s2">ysmon</span><span class="se">\c</span><span class="s2">onfig.xml"</span>
    <span class="nv">$sysmonDir</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:ProgramData</span><span class="se">\S</span><span class="s2">ysmon"</span>

    <span class="k">if</span> <span class="o">(</span><span class="nt">-not</span> <span class="o">(</span>Test-Path <span class="nv">$sysmonDir</span><span class="o">))</span> <span class="o">{</span>
        New-Item <span class="nt">-ItemType</span> Directory <span class="nt">-Path</span> <span class="nv">$sysmonDir</span> | Out-Null
    <span class="o">}</span>

    try <span class="o">{</span>
        <span class="o">[</span>Net.ServicePointManager]::SecurityProtocol <span class="o">=</span> <span class="o">[</span>Net.SecurityProtocolType]::Tls12

        Write-Output <span class="s2">"Downloading Sysmon..."</span>
        Invoke-WebRequest <span class="nt">-Uri</span> <span class="nv">$sysmonUrl</span> <span class="nt">-OutFile</span> <span class="nv">$sysmonPath</span>

        Write-Output <span class="s2">"Downloading Sysmon configuration..."</span>
        Invoke-WebRequest <span class="nt">-Uri</span> <span class="nv">$ConfigUrl</span> <span class="nt">-OutFile</span> <span class="nv">$sysmonConfigPath</span>

        Expand-Archive <span class="nt">-Path</span> <span class="nv">$sysmonPath</span> <span class="nt">-DestinationPath</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:TEMP</span><span class="se">\S</span><span class="s2">ysmon"</span> <span class="nt">-Force</span>
        &amp; <span class="s2">"</span><span class="nv">$env</span><span class="s2">:TEMP</span><span class="se">\S</span><span class="s2">ysmon</span><span class="se">\S</span><span class="s2">ysmon64.exe"</span> <span class="nt">-accepteula</span> <span class="nt">-i</span> <span class="nv">$sysmonConfigPath</span>

        <span class="c"># Cleanup</span>
        Remove-Item <span class="nt">-Recurse</span> <span class="nt">-Force</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:TEMP</span><span class="se">\S</span><span class="s2">ysmon"</span> <span class="nt">-ErrorAction</span> SilentlyContinue
        Remove-Item <span class="nt">-Force</span> <span class="nv">$sysmonPath</span> <span class="nt">-ErrorAction</span> SilentlyContinue

        Write-Output <span class="s2">"Sysmon installed successfully!"</span>
        
        <span class="c"># Configure Sysmon Event Log Size</span>
        wevtutil sl Microsoft-Windows-Sysmon/Operational /ms:2147483648 <span class="c"># 2GB</span>
    <span class="o">}</span>
    catch <span class="o">{</span>
        Write-Error <span class="s2">"Error installing Sysmon: </span><span class="nv">$_</span><span class="s2">"</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">function </span>Update-SysmonConfig <span class="o">{</span>
    Write-Host <span class="s2">"Choose update method:"</span>
    Write-Host <span class="s2">"1. Provide URL to download config file"</span>
    Write-Host <span class="s2">"2. Provide local file path"</span>
    <span class="nv">$updateChoice</span> <span class="o">=</span> Read-Host <span class="s2">"Enter your choice (1-2)"</span>

    <span class="nv">$sysmonConfigPath</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:ProgramData</span><span class="se">\S</span><span class="s2">ysmon</span><span class="se">\c</span><span class="s2">onfig.xml"</span>

    try <span class="o">{</span>
        switch <span class="o">(</span><span class="nv">$updateChoice</span><span class="o">)</span> <span class="o">{</span>
            <span class="s2">"1"</span> <span class="o">{</span>
                <span class="nv">$ConfigUrl</span> <span class="o">=</span> Read-Host <span class="s2">"Enter URL for the Sysmon configuration file"</span>
                Write-Output <span class="s2">"Downloading new Sysmon configuration..."</span>
                <span class="o">[</span>Net.ServicePointManager]::SecurityProtocol <span class="o">=</span> <span class="o">[</span>Net.SecurityProtocolType]::Tls12
                Invoke-WebRequest <span class="nt">-Uri</span> <span class="nv">$ConfigUrl</span> <span class="nt">-OutFile</span> <span class="nv">$sysmonConfigPath</span>
            <span class="o">}</span>
            <span class="s2">"2"</span> <span class="o">{</span>
                <span class="nv">$localPath</span> <span class="o">=</span> Read-Host <span class="s2">"Enter the full path to the local configuration file"</span>
                <span class="k">if</span> <span class="o">(</span>Test-Path <span class="nv">$localPath</span><span class="o">)</span> <span class="o">{</span>
                    Copy-Item <span class="nt">-Path</span> <span class="nv">$localPath</span> <span class="nt">-Destination</span> <span class="nv">$sysmonConfigPath</span> <span class="nt">-Force</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="o">{</span>
                    throw <span class="s2">"Local configuration file not found!"</span>
                <span class="o">}</span>
            <span class="o">}</span>
            default <span class="o">{</span>
                throw <span class="s2">"Invalid choice!"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        Write-Output <span class="s2">"Updating Sysmon configuration..."</span>
        &amp; <span class="s2">"C:</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\S</span><span class="s2">ysmon64.exe"</span> <span class="nt">-c</span> <span class="nv">$sysmonConfigPath</span>
        Write-Output <span class="s2">"Sysmon configuration updated successfully!"</span>
    <span class="o">}</span>
    catch <span class="o">{</span>
        Write-Error <span class="s2">"Error updating Sysmon configuration: </span><span class="nv">$_</span><span class="s2">"</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">function </span>Uninstall-Sysmon <span class="o">{</span>
    try <span class="o">{</span>
        Write-Output <span class="s2">"Uninstalling Sysmon..."</span>
        &amp; <span class="s2">"C:</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\S</span><span class="s2">ysmon64.exe"</span> <span class="nt">-u</span> force
        Remove-Item <span class="nt">-Path</span> <span class="s2">"C:</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\S</span><span class="s2">ysmon64.exe"</span> <span class="nt">-Force</span> <span class="nt">-ErrorAction</span> SilentlyContinue
        Remove-Item <span class="nt">-Path</span> <span class="s2">"C:</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\S</span><span class="s2">ysmonDrv.sys"</span> <span class="nt">-Force</span> <span class="nt">-ErrorAction</span> SilentlyContinue
        Remove-Item <span class="nt">-Path</span> <span class="s2">"</span><span class="nv">$env</span><span class="s2">:ProgramData</span><span class="se">\S</span><span class="s2">ysmon"</span> <span class="nt">-Recurse</span> <span class="nt">-Force</span> <span class="nt">-ErrorAction</span> SilentlyContinue
        Write-Output <span class="s2">"Sysmon uninstalled successfully!"</span>
    <span class="o">}</span>
    catch <span class="o">{</span>
        Write-Error <span class="s2">"Error uninstalling Sysmon: </span><span class="nv">$_</span><span class="s2">"</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c"># Main script execution</span>
<span class="nv">$sysmonInstalled</span> <span class="o">=</span> Test-Path <span class="s2">"C:</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\S</span><span class="s2">ysmonDrv.sys"</span>
<span class="nv">$action</span> <span class="o">=</span> <span class="nv">$null</span>

<span class="k">if</span> <span class="o">(</span><span class="nv">$sysmonInstalled</span><span class="o">)</span> <span class="o">{</span>
    Write-Host <span class="s2">"Sysmon is currently installed. Choose an action:"</span>
    Write-Host <span class="s2">"1. Update Sysmon configuration"</span>
    Write-Host <span class="s2">"2. Uninstall Sysmon"</span>
    Write-Host <span class="s2">"3. Enable/Update audit policies only"</span>
    Write-Host <span class="s2">"4. Exit"</span>
    <span class="nv">$action</span> <span class="o">=</span> Read-Host <span class="s2">"Enter your choice (1-4)"</span>
<span class="o">}</span>
<span class="k">else</span> <span class="o">{</span>
    Write-Host <span class="s2">"Sysmon is not installed. Choose an action:"</span>
    Write-Host <span class="s2">"1. Install Sysmon"</span>
    Write-Host <span class="s2">"2. Enable audit policies only"</span>
    Write-Host <span class="s2">"3. Exit"</span>
    <span class="nv">$action</span> <span class="o">=</span> Read-Host <span class="s2">"Enter your choice (1-3)"</span>
<span class="o">}</span>

switch <span class="o">(</span><span class="nv">$action</span><span class="o">)</span> <span class="o">{</span>
    <span class="s2">"1"</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nv">$sysmonInstalled</span><span class="o">)</span> <span class="o">{</span>
            Update-SysmonConfig
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            Install-Sysmon
        <span class="o">}</span>
        Enable-AuditPolicies
    <span class="o">}</span>
    <span class="s2">"2"</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nv">$sysmonInstalled</span><span class="o">)</span> <span class="o">{</span>
            Uninstall-Sysmon
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            Enable-AuditPolicies
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="s2">"3"</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nv">$sysmonInstalled</span><span class="o">)</span> <span class="o">{</span>
            Enable-AuditPolicies
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            Write-Output <span class="s2">"Exiting..."</span>
            <span class="nb">exit</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="s2">"4"</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nv">$sysmonInstalled</span><span class="o">)</span> <span class="o">{</span>
            Write-Output <span class="s2">"Exiting..."</span>
            <span class="nb">exit</span>
        <span class="o">}</span>
    <span class="o">}</span>
    default <span class="o">{</span>
        Write-Output <span class="s2">"Invalid choice. Exiting..."</span>
        <span class="nb">exit</span>
    <span class="o">}</span>
<span class="o">}</span>

Write-Host <span class="s2">"Press any key to exit..."</span>
<span class="nv">$null</span> <span class="o">=</span> <span class="nv">$Host</span>.UI.RawUI.ReadKey<span class="o">(</span><span class="s2">"NoEcho,IncludeKeyDown"</span><span class="o">)</span>
</pre></td> </tr></tbody></table></code></pre></div></div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/CyberDefenders-Qradar101-Write-up/">CyberDefenders Qradar101 Write up.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/Guacamole/">Step-by-step Apache Guacamole Installation.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/FnStegoCrypt/">FnStegoCrypt - Encrypted Data in Images</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/First/">FIRST Fortaleza 2023.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/CVE-2024-35250/">Detection CVE-2024-35250</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/FNLocalCloud/">Exposing Local Applications with FNLocalCloud.</a> </li> <div id="giscus_thread" style="max-width: 1000px; margin: 0 auto;"> <script>let giscusTheme=determineComputedTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"Eyezuhk/eyezuhk.github.io","data-repo-id":"R_kgDONTi2VA","data-category":"General","data-category-id":"DIC_kwDONTi2VM4Ck09L","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 Eyezuhk Isaac Fernandes. Disclaimer. All the opinions and views discussed here are mine and do not necessarily represent the views of my employer. I am not an expert. I am just sharing my views on topics, and I’m open to other perspectives. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"> <div class="modal-footer" slot="footer"> <span class="help"> <svg version="1.0" class="ninja-examplekey" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1280 1280"> <path d="M1013 376c0 73.4-.4 113.3-1.1 120.2a159.9 159.9 0 0 1-90.2 127.3c-20 9.6-36.7 14-59.2 15.5-7.1.5-121.9.9-255 1h-242l95.5-95.5 95.5-95.5-38.3-38.2-38.2-38.3-160 160c-88 88-160 160.4-160 161 0 .6 72 73 160 161l160 160 38.2-38.3 38.3-38.2-95.5-95.5-95.5-95.5h251.1c252.9 0 259.8-.1 281.4-3.6 72.1-11.8 136.9-54.1 178.5-116.4 8.6-12.9 22.6-40.5 28-55.4 4.4-12 10.7-36.1 13.1-50.6 1.6-9.6 1.8-21 2.1-132.8l.4-122.2H1013v110z"></path> </svg> to select </span> <span class="help"> <svg xmlns="http://www.w3.org/2000/svg" class="ninja-examplekey" viewbox="0 0 24 24"> <path d="M0 0h24v24H0V0z" fill="none"></path> <path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"></path> </svg> <svg xmlns="http://www.w3.org/2000/svg" class="ninja-examplekey" viewbox="0 0 24 24"> <path d="M0 0h24v24H0V0z" fill="none"></path> <path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"></path> </svg> to navigate </span> <span class="help"> <span class="ninja-examplekey esc">esc</span> to close </span> <span class="help"> <svg xmlns="http://www.w3.org/2000/svg" class="ninja-examplekey backspace" viewbox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M6.707 4.879A3 3 0 018.828 4H15a3 3 0 013 3v6a3 3 0 01-3 3H8.828a3 3 0 01-2.12-.879l-4.415-4.414a1 1 0 010-1.414l4.414-4.414zm4 2.414a1 1 0 00-1.414 1.414L10.586 10l-1.293 1.293a1 1 0 101.414 1.414L12 11.414l1.293 1.293a1 1 0 001.414-1.414L13.414 10l1.293-1.293a1 1 0 00-1.414-1.414L12 8.586l-1.293-1.293z" clip-rule="evenodd"></path> </svg> move to parent </span> </div> </ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"About",section:"Navigation menu",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"Blog",description:"A collection of my cybersecurity thoughts and personal opinions covering a variety of topics.",section:"Navigation menu",handler:()=>{window.location.href="/blog/"}},{id:"nav-differ",title:"Differ",description:"",section:"Navigation menu",handler:()=>{window.location.href="/Differ/"}},{id:"nav-htmlive",title:"HTMLive",description:"",section:"Navigation menu",handler:()=>{window.location.href="/HTMLive/"}},{id:"nav-pomodoro",title:"Pomodoro",description:"",section:"Navigation menu",handler:()=>{window.location.href="/Pomodoro/"}},{id:"nav-cv",title:"CV",description:"Curriculum Vitae.",section:"Navigation menu",handler:()=>{window.location.href="/cv/"}},{id:"nav-github-repositories",title:"Github Repositories",description:"Personal projects.",section:"Navigation menu",handler:()=>{window.location.href="/github-repositories/"}},{id:"post-detection-cve-2024-35250",title:"Detection CVE-2024-35250",description:"Detects when cmd.exe with system privileges is executed after a process loads &#39;ksproxy.ax&#39; and &#39;ksuser.dll&#39;, indicating potential exploitation of CVE-2024-35250.",section:"Posts",handler:()=>{window.location.href="/blog/2024/CVE-2024-35250/"}},{id:"post-apts-or-uaps",title:"APTs or UAPs?",description:"How Anomalous Phenomena Are Similar to Cyber Threats.",section:"Posts",handler:()=>{window.location.href="/blog/2024/APT-UAP/"}},{id:"post-step-by-step-apache-guacamole-installation",title:"Step-by-step Apache Guacamole Installation.",description:"Guacamole Instalation",section:"Posts",handler:()=>{window.location.href="/blog/2024/Guacamole/"}},{id:"post-script-for-enabling-windows-audit-and-sysmon",title:"Script for enabling Windows Audit and Sysmon.",description:"Windows audit and Sysmon",section:"Posts",handler:()=>{window.location.href="/blog/2024/Audit-Sysmon/"}},{id:"post-fnstegocrypt-encrypted-data-in-images",title:"FnStegoCrypt - Encrypted Data in Images",description:"A program that encrypts data using AES-GCM and embeds it into images with LSB.",section:"Posts",handler:()=>{window.location.href="/blog/2024/FnStegoCrypt/"}},{id:"post-exposing-local-applications-with-fnlocalcloud",title:"Exposing Local Applications with FNLocalCloud.",description:"An agent-server based program to expose local network services on the internet, bypassing CGNAT.",section:"Posts",handler:()=>{window.location.href="/blog/2024/FNLocalCloud/"}},{id:"post-first-fortaleza-2023",title:"FIRST Fortaleza 2023.",description:"FIRST (Forum of Incident Response and Security Teams)",section:"Posts",handler:()=>{window.location.href="/blog/2023/First/"}},{id:"post-cyberdefenders-qradar101-write-up",title:"CyberDefenders Qradar101 Write up.",description:"Ctf Writeup",section:"Posts",handler:()=>{window.location.href="/blog/2022/CyberDefenders-Qradar101-Write-up/"}},{id:"news-memento-mori",title:"Memento mori.",description:"",section:"News"},{id:"projects-projects",title:"Projects",description:"with background image",section:"Projects",handler:()=>{window.location.href="/projects/1_project/"}},{id:"socials-email",title:"Send an email",section:"Socials",handler:()=>{window.open("mailto:%65%79%65%7A%75%68%6B@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/Eyezuhk","_blank")}},{id:"socials-linkedin",title:"LinkedIn",section:"Socials",handler:()=>{window.open("https://www.linkedin.com/in/isaacfn","_blank")}},{id:"socials-spotify",title:"Spotify",section:"Socials",handler:()=>{window.open("https://open.spotify.com/user/12144303025","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"lang-pt-br",title:"pt-br",section:"Languages",handler:()=>{window.location.href="/pt-br/blog/2024/Audit-Sysmon/"}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>